# Matchmaker

The matchmaker service selects groups of players suitable for playing multiplayer matches together.

## Invoking the API

You have several options.

1. Geneerate a Connect RPC client from the API spec.
   So far this is only possible for Go.
2. Generate a gRPC / gRPC-Web client from the API spec.
   `connect-go` is compatible with those.
3. Use cURL / an HTTP client.
   - See the docs on [invoking Connect APIs with HTTP clients].
   - The [JSON <-> Protobuf mapping] is documented separately

[invoking Connect APIs with HTTP clients]: https://connect.build/docs/browsers-and-curl
[JSON <-> Protobuf mapping]: https://developers.google.com/protocol-buffers/docs/proto3#json

## File structure

**File/Directory** | **Description**
---|---
`cmd/matchmaker` | The application.
`Earthfile` | [Earthly] build script.
`gen` | Autogenerated code.
`generate.go` | Code generation configuration.
`rpc/matchmaking/v1` | Adapters for the API (major version 1).
`rpc/matchmaking/v1/api.proto` | API speicification (major version 1).
`tools.go` | Conventional Go file importing development tools. See wiki on [`tools.go`].

[Earthly]: https://earthly.dev/
[`tools.go`]: https://github.com/golang/go/wiki/Modules/6ae647c7e344bc643f9ab7478e9cdd77b8795f72#how-can-i-track-tool-dependncies-for-a-module=

## Configuration

The following environment variables are supported.

 **Name** | **Description** | **Example**
---|---|---
`LOG_LEVEL` | A zerolog-compatible log level value. | `info` (default)
`PORT` | The port for the HTTP server to listen at. | `4447` (default)
`ZONEINFO` | Preferred [tz database] location. See [`time.LoadLocation`] | `/zoneinfo` (default: empty)

[tz database]: https://en.wikipedia.org/wiki/Tz_database
[`time.LoadLocation`]: https://pkg.go.dev/time#LoadLocation

## Development

You will need:

- `go` (at least 1.18)
- `docker`
- `earthly`

### For each commit

Ensure the `go.mod` and `go.sum` files are tidy.
Run the following command after changing dependencies.

```
go mod tidy
```

Ensure the code is properly formatted.
Run the following command if your editor does not do this for you already.

```
go fmt ./...
```

Ensure the autogenerated code is up to date.
If you changed

- the API specification,
- tool dependency versions, or
- `generate.go`

run the following command:

```
go generate ./...

```

### Build container image

```bash
earthly +container-image
```

Alternatively, from the repository root

```bash
earthly ./matchmaker+container-image
```
